<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Búsqueda de Productos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="estilo.css">
</head>
<body>
  <nav style="background:#222;padding:10px 0 10px 0;text-align:center;margin-bottom:20px;">
    <a href="catalogo.html" style="color:#fff;margin:0 15px;text-decoration:none;font-weight:bold;">Catálogo</a>
    <a href="busqueda.html" style="color:#fff;margin:0 15px;text-decoration:none;font-weight:bold;">Búsqueda</a>
    <a href="favoritos.html" style="color:#fff;margin:0 15px;text-decoration:none;font-weight:bold;">Favoritos</a>
  </nav>
  <h1>Búsqueda y Filtros</h1>
  <div id="filtros">
    <input type="text" id="busquedaNombre" placeholder="Buscar por nombre">
    <select id="busquedaCategoria">
      <option value="">Todas las categorías</option>
    </select>
    <input type="number" id="precioMin" placeholder="Precio mínimo">
    <input type="number" id="precioMax" placeholder="Precio máximo">
    <button onclick="buscar()">Buscar</button>
  </div>
  <table>
    <thead>
      <tr><th>Nombre</th><th>Categoría</th><th>Precio</th><th>Stock</th><th>Descripción</th></tr>
    </thead>
    <tbody id="resultados"></tbody>
  </table>
  <script>
    const API = 'http://localhost:4550';
    let categorias = [];
    async function cargarCategorias() {
      const res = await fetch(API + '/productos');
      const productos = await res.json();
      categorias = [...new Set(productos.map(p => p.categoria).filter(Boolean))];
      const select = document.getElementById('busquedaCategoria');
      categorias.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }
    function validarBusqueda() {
      const precioMin = document.getElementById('precioMin').value;
      const precioMax = document.getElementById('precioMax').value;
      let errores = [];
      if (precioMin && (isNaN(precioMin) || Number(precioMin) < 0)) errores.push('Precio mínimo inválido.');
      if (precioMax && (isNaN(precioMax) || Number(precioMax) < 0)) errores.push('Precio máximo inválido.');
      if (precioMin && precioMax && Number(precioMin) > Number(precioMax)) errores.push('El precio mínimo no puede ser mayor que el máximo.');
      if (errores.length) {
        alert(errores.join('\n'));
        return false;
      }
      return true;
    }
    async function buscar() {
      if (!validarBusqueda()) return;
      const nombre = document.getElementById('busquedaNombre').value.toLowerCase();
      const categoria = document.getElementById('busquedaCategoria').value;
      const precioMin = parseFloat(document.getElementById('precioMin').value);
      const precioMax = parseFloat(document.getElementById('precioMax').value);
      const res = await fetch(API + '/productos');
      const productos = await res.json();
      const filtrados = productos.filter(p => {
        let ok = true;
        if (nombre && !p.nombre.toLowerCase().includes(nombre)) ok = false;
        if (categoria && p.categoria !== categoria) ok = false;
        if (!isNaN(precioMin) && p.precio < precioMin) ok = false;
        if (!isNaN(precioMax) && p.precio > precioMax) ok = false;
        return ok;
      });
      const tabla = document.getElementById('resultados');
      tabla.innerHTML = '';
      filtrados.forEach(p => {
        tabla.innerHTML += `<tr>
    <td>${escapeHtml(p.nombre)}</td>
    <td>${escapeHtml(p.categoria||'')}</td>
    <td>${p.precio}</td>
    <td>${p.stock}</td>
    <td>${escapeHtml(p.descripcion||'')}</td>
  </tr>`;
      });
    }
    function escapeHtml(text) {
      return String(text).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }
    cargarCategorias();
    buscar();
  </script>
</body>
</html>
