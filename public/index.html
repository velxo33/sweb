<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Catálogo de Productos</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    input, textarea { display: block; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    img { max-width: 80px; max-height: 80px; display: block; }
    button { margin-right: 5px; }
    .agotado { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Catálogo de Productos</h1>

  <div class="auth-section">
    <h2>Registro / Login</h2>
    <input type="text" id="reg-nombre" placeholder="Nombre">
    <input type="email" id="reg-correo" placeholder="Correo">
    <input type="password" id="reg-clave" placeholder="Contraseña">
    <select id="reg-rol">
      <option value="visitante">Visitante</option>
      <option value="admin">Administrador</option>
    </select>
    <button onclick="registrar()">Registrar</button>
    <br><br>
    <input type="email" id="login-correo" placeholder="Correo">
    <input type="password" id="login-clave" placeholder="Contraseña">
    <button onclick="login()">Iniciar sesión</button>
    <p id="estado-login"></p>
  </div>

  <div class="admin-only" id="form-container" style="display: none;">
    <h2>Agregar / Editar Producto</h2>
    <form id="formulario">
      <input type="text" id="nombre" placeholder="Nombre" required>
      <input type="number" id="precio" placeholder="Precio" required>
      <textarea id="descripcion" placeholder="Descripción"></textarea>
      <input type="number" id="stock" placeholder="Stock" required>
      <input type="file" id="imagen" accept="image/*">
      <button type="submit">Guardar</button>
    </form>
  </div>

  <h2>Lista de Productos</h2>
  <table>
    <thead>
      <tr>
        <th>Imagen</th>
        <th>Nombre</th>
        <th>Precio</th>
        <th>Descripción</th>
        <th>Stock</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tabla-productos"></tbody>
  </table>

  <script>
    const API = 'http://localhost:4550';
    let token = '';
    let rol = '';
    let editandoId = null;

    async function registrar() {
      const nombre = document.getElementById('reg-nombre').value;
      const correo = document.getElementById('reg-correo').value;
      const clave = document.getElementById('reg-clave').value;
      const rol = document.getElementById('reg-rol').value;

      const res = await fetch(API + '/auth/registro', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, correo, contraseña: clave, rol })
      });

      const data = await res.json();
      alert(data.mensaje || 'Registrado');
    }

    async function login() {
      const correo = document.getElementById('login-correo').value;
      const clave = document.getElementById('login-clave').value;

      const res = await fetch(API + '/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo, contraseña: clave })
      });

      const data = await res.json();
      if (data.token) {
        token = data.token;
        const payload = JSON.parse(atob(token.split('.')[1]));
        rol = payload.rol;

        document.getElementById('estado-login').innerText = 'Sesión iniciada como ' + rol;
        if (rol === 'admin') {
          document.getElementById('form-container').style.display = 'block';
        }
        cargarProductos();
      } else {
        document.getElementById('estado-login').innerText = data.mensaje || 'Error al iniciar sesión';
      }
    }

    async function cargarProductos() {
      const res = await fetch(API + '/productos');
      const productos = await res.json();
      const tabla = document.getElementById('tabla-productos');
      tabla.innerHTML = '';
      productos.forEach(p => {
        tabla.innerHTML += `
          <tr>
            <td>${p.imagen ? `<img src="http://localhost:4550${p.imagen}" alt="producto">` : ''}</td>
            <td>${p.nombre}</td>
            <td>${p.precio}</td>
            <td>${p.descripcion || ''}</td>
            <td>${p.stock <= 0 ? '<span class="agotado">Agotado</span>' : p.stock}</td>
            <td>
              ${rol === 'admin' ? `
                <button onclick="editarProducto('${p._id}')">Editar</button>
                <button onclick="eliminarProducto('${p._id}')">Eliminar</button>
              ` : ''}
              ${token ? `<button onclick="verDetalles('${p._id}')">Ver detalles / reseñas</button>` : ''}
            </td>
          </tr>
        `;
      });
    }

    window.eliminarProducto = async (id) => {
      if (!token) return alert('No autorizado');
      if (confirm('¿Seguro que deseas eliminar?')) {
        await fetch(API + `/productos/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        cargarProductos();
      }
    };

    window.editarProducto = async (id) => {
      const res = await fetch(API + `/productos/${id}`);
      const p = await res.json();
      document.getElementById('nombre').value = p.nombre;
      document.getElementById('precio').value = p.precio;
      document.getElementById('descripcion').value = p.descripcion;
      document.getElementById('stock').value = p.stock;
      editandoId = p._id;
    };

    document.getElementById('formulario').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData();
      formData.append('nombre', document.getElementById('nombre').value);
      formData.append('precio', document.getElementById('precio').value);
      formData.append('descripcion', document.getElementById('descripcion').value);
      formData.append('stock', document.getElementById('stock').value);

      const imagen = document.getElementById('imagen').files[0];
      if (imagen) formData.append('imagen', imagen);

      const url = editandoId ? `${API}/productos/${editandoId}` : `${API}/productos`;
      const method = editandoId ? 'PUT' : 'POST';

      const options = {
        method: method,
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
      };

      await fetch(url, options);
      document.getElementById('formulario').reset();
      editandoId = null;
      cargarProductos();
    });

    cargarProductos(); // Carga inicial
  

function verDetalles(id) {
  cargarReseñas(id);
  document.getElementById('reseñas-container').scrollIntoView({ behavior: 'smooth' });
}

</script>
</body>
</html>

<!-- Sección de reseñas -->
<div id="reseñas-container" style="margin-top: 30px;">
  <h3>Reseñas</h3>
  <div id="promedio-calificacion"></div>
  <ul id="lista-reseñas"></ul>
  <div id="form-reseña" style="margin-top: 20px; display: none;">
    <textarea id="comentario" placeholder="Escribe tu comentario..." required></textarea>
    <select id="estrellas">
      <option value="5">★★★★★</option>
      <option value="4">★★★★☆</option>
      <option value="3">★★★☆☆</option>
      <option value="2">★★☆☆☆</option>
      <option value="1">★☆☆☆☆</option>
    </select>
    <button onclick="enviarReseña()">Enviar Reseña</button>
  </div>
</div>

<script>
  let productoActualId = null;

  async function cargarReseñas(productoId) {
    productoActualId = productoId;

    // Mostrar promedio
    const resProm = await fetch(`${API}/resenas/${productoId}/promedio`);
    const { promedio } = await resProm.json();
    document.getElementById('promedio-calificacion').innerText = `Promedio: ${promedio} ★`;

    // Mostrar lista de reseñas
    const resLista = await fetch(`${API}/resenas/${productoId}`);
    const reseñas = await resLista.json();
    const ul = document.getElementById('lista-reseñas');
    ul.innerHTML = '';
    reseñas.forEach(r => {
      ul.innerHTML += `<li><strong>${r.usuario.nombre}</strong>: ${r.estrellas}★ - ${r.comentario}</li>`;
    });

    // Mostrar formulario si está logueado
    document.getElementById('form-reseña').style.display = token ? 'block' : 'none';
  }

  async function enviarReseña() {
    const comentario = document.getElementById('comentario').value;
    const estrellas = document.getElementById('estrellas').value;

    await fetch(`${API}/resenas/${productoActualId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ comentario, estrellas })
    });

    document.getElementById('comentario').value = '';
    cargarReseñas(productoActualId);
  }


function verDetalles(id) {
  cargarReseñas(id);
  document.getElementById('reseñas-container').scrollIntoView({ behavior: 'smooth' });
}

</script>
