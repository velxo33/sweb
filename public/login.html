<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="estilo.css">
</head>
<body>
  <div class="container">
    <h1>Login / Registro</h1>
    <input type="text" id="reg-nombre" placeholder="Nombre">
    <input type="email" id="reg-correo" placeholder="Correo">
    <input type="password" id="reg-clave" placeholder="Contraseña">
    <select id="rol" name="rol" required>
      <option value="cliente">Cliente</option>
      <option value="visitante">Visitante</option>
    </select>
    <button onclick="registrar()">Registrar</button>
    <hr>
    <input type="email" id="login-correo" placeholder="Correo">
    <input type="password" id="login-clave" placeholder="Contraseña">
    <button onclick="login()">Iniciar sesión</button>
    <p id="estado-login"></p>
  </div>

  <script>
const API = 'http://localhost:4550';

function validarEmail(email) {
  return /^[^@]+@[^@]+\.[a-zA-Z]{2,}$/.test(email);
}

function mostrarEstado(msg, tipo = 'error') {
  const estado = document.getElementById('estado-login');
  estado.innerText = msg;
  estado.className = tipo;
  estado.scrollIntoView({ behavior: 'smooth' });
}

async function registrar() {
  const nombre = document.getElementById('reg-nombre').value.trim();
  const correo = document.getElementById('reg-correo').value.trim();
  const clave = document.getElementById('reg-clave').value;
  const rol = document.getElementById('rol').value;
  let errores = [];

  if (nombre.length < 2 || nombre.length > 50) errores.push('El nombre debe tener entre 2 y 50 caracteres.');
  if (!/^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$/.test(nombre)) errores.push('El nombre solo puede contener letras y espacios.');
  if (!validarEmail(correo)) errores.push('Correo inválido.');
  if (clave.length < 8 || clave.length > 32) errores.push('La contraseña debe tener entre 8 y 32 caracteres.');

  if (errores.length) {
    mostrarEstado(errores.join('\n'));
    return;
  }

  const res = await fetch(API + '/auth/registro', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ nombre, correo, contraseña: clave, rol })
  });
  const data = await res.json();
  if (res.ok) {
    mostrarEstado(data.mensaje || 'Registrado', 'success');
    document.getElementById('reg-nombre').value = '';
    document.getElementById('reg-correo').value = '';
    document.getElementById('reg-clave').value = '';
  } else {
    mostrarEstado(data.mensaje || 'Error al registrar');
  }
}

async function login() {
  const correo = document.getElementById('login-correo').value.trim();
  const clave = document.getElementById('login-clave').value;
  let errores = [];
  if (!validarEmail(correo)) errores.push('Correo inválido.');
  if (clave.length < 8 || clave.length > 32) errores.push('La contraseña debe tener entre 8 y 32 caracteres.');
  if (errores.length) {
    mostrarEstado(errores.join('\n'));
    return;
  }
  const res = await fetch(API + '/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ correo, contraseña: clave })
  });
  const data = await res.json();
  if (data.token) {
    localStorage.setItem('token', data.token);
    localStorage.setItem('rol', data.rol);
    localStorage.setItem('nombre', data.nombre);
    document.getElementById('login-correo').value = '';
    document.getElementById('login-clave').value = '';
    window.location.href = 'catalogo.html';
  } else {
    mostrarEstado(data.mensaje || 'Error en login');
  }
}
</script>
</body>
</html>